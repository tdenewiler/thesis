\documentclass[12pt]{article}

% Input and configure the required packages.
\input{preamble}

% Document starts here.
\begin{document}
\title{Notes on Lyapunov Controller}
\author{Thomas Denewiler}
\maketitle

% Meat and potatoes.
\section{Control Law}
\begin{align}
\label{eq:lyapunovControlLaw}
\begin{split}
u &= \gamma e\cos\alpha \\
\omega &= k\alpha + \gamma\frac{\cos\alpha\sin\alpha}{\alpha}\left(\alpha+h\theta\right)
\end{split}
\end{align}

\begin{figure}[ht!]
	\centering
	\includegraphics[width=.95\textwidth]{images/packbotlyapunov}
	\caption{PackBot with coordinate system for the Lyapunov controller.}
	\label{fig:pblyapunov}
\end{figure}

\section{Variables}
\begin{table}[ht!]
\caption{Variables needed for Lyapunov controller.}
\small
\centering
\begin{tabular}{@{}lllr@{}} \toprule
Description                   & Figure         & Units   & Range \\ \midrule
Distance error                & $e$            & meters  & N/A \\
Robot heading                 & $\psi$         & radians & $(-\pi,\pi]$ \\
Goal heading                  & $\theta^\star$ & radians & $(-\pi,\pi]$ \\
Heading error                 & $\theta$       & radians & $(-\pi,\pi]$ \\
Heading error - robot heading & $\alpha$       & radians & $(-\pi,\pi]$ \\
Goal heading - robot heading  & $\phi$         & radians & $(-\pi,\pi]$ \\ \bottomrule
\end{tabular}
\label{tab:LyapunovVariables}
\end{table}

The way to calculate the variables is:
\begin{enumerate}
\item $dx$ is the vertical component of the error vector $e$ since the $x-$axis is forward of the vehicle as seen in Figure \ref{fig:pblyapunov}.
\item $dy$ is the horizontal component of the error vector $e$ as seen in Figure \ref{fig:pblyapunov}.
\item $e$ can be calculated in several different ways:
\begin{itemize}
\item Use \texttt{Path\_Executor()} to set a carrot out front of the robot on the path. The carrot moves out along the next path segment when the robot gets close enough to the end waypoint of the current path segment. This could cause $e$ to be much smaller than it actually is so $\alpha$ will be corrected before it should be and a problem could occur if the robot tries to correct $\theta$ too early.
\item Use \texttt{sqrt(pow(dx,2) + pow(dy,2))} to get the distance to the end waypoint on the current path segment. This will cause the robot to slow down as it reaches every waypoint, even intermediate ones. Conversely, if $e$ is very large then $u$ could grow to be too large as well and necessitate the use of a limiting value for $u$.
\item Combine the two methods and use the actual distance to the end waypoint of the current path segment until that value is less than the distance to the carrot and then use the carrot distance for $e$.
\end{itemize}
\item $\psi$ is the current heading of the robot in the world coordinate frame and ends up being \texttt{globalPose.yaw} from \texttt{PBGlobalWaypointDriver} which is available from the \texttt{Get\_Heading()} function.
\item $\alpha$ is the angle between the current heading of the robot $\psi$ and the error vector $e$ where the angle of the error vecotr $e$ is from the current position to the waypoint and found as $\tan^{-1}\left(\frac{dy}{dx}\right)$. The desired angle error is $\alpha = \tan^{-1}\left(\frac{dx}{dy}\right) - \psi$.
\item $\theta^\star$ is the desired heading in the global coordinate system and there are multiple ways that it \textit{could} be set.
\begin{itemize}
\item $\theta^\star=0$ would just make the desired heading be North.
\item $\theta^\star=\psi$ would make the desired heading be the same as whatever the current heading happens to be.
\item It could be sent in as part of a waypoint, say from MOCU via JAUS.
\item Look at the current waypoint and next waypoint positions. If there is no next waypoint then just go straight to the current waypoint with $\theta^\star=\psi$. If there is a next waypoint then the $\theta^\star$ could be the angle from the current waypoint to the next waypoint or splitting the difference between heading to the current and next waypoints.
\end{itemize}
\item $\phi=\theta^\star-\psi$.
\item $\theta=\alpha + \phi$.
\end{enumerate}
Don't forget that all of the angle variables need to be normalized so that they are in the range $(-\pi,\pi]$.

\section{Effect of Gains on Angular Velocity}
The most important item to note is that when driving a robot with a coordinate system such as that shown in Figure \ref{fig:packbotaxes} $\omega>0\Rightarrow$ \textit{turn left} and $\omega<0\Rightarrow$ \textit{turn right}. This is a consequence of how the $x$-, $y$- and $z$-axes are defined in Figure \ref{fig:packbotaxes} where the positive $x$-axis is forward of the vehicle and the positive $y$-axis is left of the vehicle. Following the right-hand rule the $z$-axis is required to be positive in the up direction and positive rotations about the $z$-axis (or changes in yaw due to the angular velocity command) move from the positive $x$-axis to the positive $y$-axis.

It is also helpful to rewrite the angular velocity output from the control law (\ref{eq:lyapunovControlLaw}) as
\begin{align*}
\omega = k\alpha + \gamma\cos\alpha\sin\alpha + \frac{\gamma h\theta\cos\alpha\sin\alpha}{\alpha}
\end{align*}

\begin{figure}[ht!]
	\centering
	\includegraphics[width=.5\textwidth]{images/packbotaxes}
	\caption{Body centered coordinate frame for PackBot.}
	\label{fig:packbotaxes}
\end{figure}

There are three gains that affect the angular velocity output: $h$, $k$ and $\gamma$. The gains are all coupled in a nonlinear fashion so it can be difficult to intuitively understand how the angular velocity output will change as the gains are modified. In ACS angles are defined to be in the range $(-\pi,\pi]$ as well and Figure \ref{fig:plotSinCos} shows several useful trigonometric functions of $\alpha$ in the range of interest.

\begin{figure}[ht!]
	\centering
	\includegraphics[width=.75\textwidth]{images/plotSinCos}
	\caption{Plot of $\alpha$, $\sin\alpha$, $\cos\alpha$ and $\sin\alpha*\cos\alpha$.}
	\label{fig:plotSinCos}
\end{figure}

When looking at the angular velocity output and the gains there are thirteen combinations that can be used when setting the gain values relative to each other as shown in Table \ref{tab:gainsAngVelOutput}. Note that when two variables are larger than one variable some terms cancel out as the effects of the term with the smaller gain value diminish. The gains also have different effects depending on which quadrant $\alpha$ and $\theta$ are in as shown for $\alpha$ in Figure \ref{fig:robotAlpha}.

\begin{figure}[ht!]
	\centering
	\includegraphics[width=.3\textwidth]{images/robotAlpha}
	\caption{Different $\alpha$ values for varying target positions.}
	\label{fig:robotAlpha}
\end{figure}

\begin{table}[ht!]
\caption{Gains and angular velocity output.}
\small
\centering
\begin{tabular}{@{}lllr@{}} \toprule
Scenario & Gains                     & Angular Velocity $\omega$                                                                                     \\ \midrule
1        & $h\approx k\approx\gamma$ & $\omega\approx k\alpha + \gamma\cos\alpha\sin\alpha + \gamma h\theta\cos\alpha\sin\alpha/\alpha$              \\
2        & $h\gg k,\gamma$           & $\omega\approx \gamma h\theta\cos\alpha\sin\alpha/\alpha$                                                     \\
3        & $k\gg h,\gamma$           & $\omega\approx k\alpha$                                                                                       \\
4        & $\gamma\gg h,k$           & $\omega\approx \gamma\cos\alpha\sin\alpha$                                                                    \\
5        & $h,k \gg\gamma$           & $\omega\approx k\alpha\cancelto{0}{+\gamma h\theta\cos\alpha\sin\alpha/\alpha}$                               \\
6        & $h,\gamma\gg k$           & $\omega\approx \cancelto{0}{\gamma\cos\alpha\sin\alpha+} \gamma h\theta\cos\alpha\sin\alpha/\alpha$           \\
7        & $k,\gamma\gg h$           & $\omega\approx k\alpha + \gamma\cos\alpha\sin\alpha \cancelto{0}{+\gamma h\theta\cos\alpha\sin\alpha/\alpha}$ \\
8        & $h\gg k\gg\gamma$         & $\omega\approx \gamma h\theta\cos\alpha\sin\alpha/\alpha$                                                     \\
9        & $h\gg\gamma\gg k$         & $\omega\approx \gamma h\theta\cos\alpha\sin\alpha/\alpha$                                                     \\
10       & $k\gg h\gg\gamma$         & $\omega\approx k\alpha$                                                                                       \\
11       & $k\gg\gamma\gg h$         & $\omega\approx k\alpha$                                                                                       \\
12       & $\gamma\gg h\gg k$        & $\omega\approx \gamma\cos\alpha\sin\alpha$                                                                    \\
13       & $\gamma\gg k\gg h$        & $\omega\approx \gamma\cos\alpha\sin\alpha$                                                                    \\ \bottomrule
\end{tabular}
\label{tab:gainsAngVelOutput}
\end{table}

\begin{table}[ht!]
\caption{Gains and ratio of linear/angular velocity output.}
\small
\centering
\begin{tabular}{@{}llr@{}} \toprule
Scenario & Gains                     & $u/\omega$                                                                                        \\ \midrule
1        & $h\approx k\approx\gamma$ & $\cancelto{1}{\tfrac{\gamma}{k}}\tfrac{e}{\alpha}\cos\alpha + e\sin\alpha + \tfrac{e\alpha}{h\theta\sin\alpha}$ \\
2        & $h\gg k,\gamma$           & $\cancelto{1}{\tfrac{\gamma}{k}}\tfrac{e}{\alpha}\cos\alpha + e\sin\alpha + \cancelto{0}{\tfrac{e\alpha}{h\theta\sin\alpha}}$ \\
3        & $k\gg h,\gamma$           & $\cancelto{0}{\tfrac{\gamma}{k}\tfrac{e}{\alpha}\cos\alpha} + e\sin\alpha + \tfrac{e\alpha}{h\theta\sin\alpha}$ \\
4        & $\gamma\gg h,k$           & $\tfrac{\gamma}{k}\tfrac{e}{\alpha}\cos\alpha + \cancelto{0}{e\sin\alpha} + \cancelto{0}{\tfrac{e\alpha}{h\theta\sin\alpha}}$ \\
5        & $h,k \gg\gamma$           & $\cancelto{0}{\tfrac{\gamma}{k}\tfrac{e}{\alpha}\cos\alpha} + e\sin\alpha + \cancelto{0}{\tfrac{e\alpha}{h\theta\sin\alpha}}$ \\
6        & $h,\gamma\gg k$           & $\tfrac{\gamma}{k}\tfrac{e}{\alpha}\cos\alpha + \cancelto{0}{e\sin\alpha} + \cancelto{0}{\tfrac{e\alpha}{h\theta\sin\alpha}}$ \\
7        & $k,\gamma\gg h$           & $\cancelto{0}{\cancelto{1}{\tfrac{\gamma}{k}}\tfrac{e}{\alpha}\cos\alpha} + \cancelto{0}{e\sin\alpha} + \tfrac{e\alpha}{h\theta\sin\alpha}$ \\
8        & $h\gg k\gg\gamma$         & $\cancelto{0}{\tfrac{\gamma}{k}\tfrac{e}{\alpha}\cos\alpha} + e\sin\alpha + \cancelto{0}{\tfrac{e\alpha}{h\theta\sin\alpha}}$ \\
9        & $h\gg\gamma\gg k$         & $\tfrac{\gamma}{k}\tfrac{e}{\alpha}\cos\alpha + \cancelto{0}{e\sin\alpha} + \cancelto{0}{\tfrac{e\alpha}{h\theta\sin\alpha}}$ \\
10       & $k\gg h\gg\gamma$         & $\cancelto{0}{\tfrac{\gamma}{k}\tfrac{e}{\alpha}\cos\alpha} + e\sin\alpha + \tfrac{e\alpha}{h\theta\sin\alpha}$ \\
11       & $k\gg\gamma\gg h$         & $\cancelto{0}{\tfrac{\gamma}{k}\tfrac{e}{\alpha}\cos\alpha} + \cancelto{0}{e\sin\alpha} + \tfrac{e\alpha}{h\theta\sin\alpha}$ \\
12       & $\gamma\gg h\gg k$        & $\tfrac{\gamma}{k}\tfrac{e}{\alpha}\cos\alpha + \cancelto{0}{e\sin\alpha} + \cancelto{0}{\tfrac{e\alpha}{h\theta\sin\alpha}}$ \\
13       & $\gamma\gg k\gg h$        & $\tfrac{\gamma}{k}\tfrac{e}{\alpha}\cos\alpha + \cancelto{0}{e\sin\alpha} + \tfrac{e\alpha}{h\theta\sin\alpha}$ \\ \bottomrule
\end{tabular}
\label{tab:gainsLinAngVelRelation}
\end{table}

\end{document}
